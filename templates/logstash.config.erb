input {
  http {
    port => 80
  }
}

filter {
  if [headers][request_method] != "POST" {
    # Drop all non-POST requests. Healthchecks happen over HTTP GET,
    # and we don't want those getting into Logstash.
    drop { }
  }

  mutate { remove_field => ["headers"]}
}

output {
  if [olympus_req_headers] =~ "\"olympus-region\":\s*\"EU\"" {
    s3 {
      access_key_id => "${AWS_ACCESS_KEY_ID}"
      secret_access_key => "${AWS_SECRET_ACCESS_KEY}"
      region => "eu-central-1"
      bucket => "${AWS_LOG_BUCKET_EU}"
      server_side_encryption => true
      codec => "json"
      encoding => "gzip"
    }

    http {
      format => "json"
      content_type => "application/json"
      http_method => "post"
      url => "${SPLUNK_HEC_ENDPOINT}"
      headers => {"Authorization" => "Splunk ${SPLUNK_HEC_TOKEN}"}
    }
  } else if (
      [olympus_req_headers] =~ "\"olympus-region\":\s*\"US\""
      or !([olympus_req_headers] =~ "\"olympus-region\":")
  ) {
    s3 {
      access_key_id => "${AWS_ACCESS_KEY_ID}"
      secret_access_key => "${AWS_SECRET_ACCESS_KEY}"
      region => "us-east-1"
      bucket => "${AWS_LOG_BUCKET}"
      server_side_encryption => true
      codec => "json"
      encoding => "gzip"
    }

    http {
      format => "json"
      content_type => "application/json"
      http_method => "post"
      url => "${SPLUNK_HEC_ENDPOINT}"
      headers => {"Authorization" => "Splunk ${SPLUNK_HEC_TOKEN}"}
    }
  }
}
